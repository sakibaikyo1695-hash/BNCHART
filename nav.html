<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>BN Chart 70001 by Sadman</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body { margin:0; padding:0; font-family:Arial, sans-serif; }

#map { position:absolute; top:0; bottom:0; left:0; right:320px; }

#sidebar {
  position:absolute;
  right:0;
  top:0;
  bottom:0;
  width:320px;
  padding:12px;
  background:#f7f7f7;
  overflow:auto;
  border-left:1px solid #ccc;
}

h3,h4{ margin:6px 0; }

.btn {
  display:inline-block;
  padding:7px 10px;
  margin:3px 2px;
  background:#2a9df4;
  color:white;
  border-radius:4px;
  text-decoration:none;
  cursor:pointer;
  font-size:13px;
}

.btn.small { padding:3px 6px; font-size:12px; }

input[type=text], textarea {
  width:100%;
  box-sizing:border-box;
  padding:6px;
  margin:3px 0;
}

.coord-input-group {
  display: flex;
  gap: 4px;
  margin: 3px 0;
  align-items: center;
}

.coord-input-group input {
  flex: 1;
  padding: 6px;
  margin: 0;
}

.coord-input-group select {
  padding: 6px;
  margin: 0;
}

.coord-label {
  font-size: 12px;
  font-weight: bold;
  margin-top: 6px;
  margin-bottom: 2px;
}

.waypoint-item {
  border-bottom:1px dashed #ccc;
  padding:4px;
  margin-bottom:4px;
}

.small { font-size:12px; color:#666; }

#routeSummary { font-size:12px; margin-top:6px; }

#credit {
  position:absolute;
  bottom:8px;
  right:330px;
  background:rgba(255,255,255,0.85);
  font-size:12px;
  color:#333;
  padding:4px 8px;
  border-radius:4px;
  border:1px solid #ccc;
  font-weight:bold;
}

/* iPad / smaller screens */
@media (max-width: 900px){
  #map{ right:0; bottom:45%; }
  #sidebar{
    width:100%;
    height:45%;
    top:auto;
    bottom:0;
    border-left:none;
    border-top:1px solid #ccc;
  }
  #credit{ right:10px; bottom:50%; }
}
</style>
</head>

<body>

<div id="map"></div>
<div id="credit">MADE BY LT CDR SADMAN, P NO 3223</div>

<div id="sidebar">
  <h3>BN Chart 70001 by Sadman</h3>
  <small class="small">Click map to add waypoint. Click waypoint to select/edit.</small>

  <h4>Jump to Location:</h4>
  
  <div class="coord-label">Latitude:</div>
  <div class="coord-input-group">
    <input id="latDeg" placeholder="Deg" type="text" style="width:50px;"/>
    <span>¬∞</span>
    <input id="latMin" placeholder="Min" type="text" style="width:60px;"/>
    <span>'</span>
    <select id="latDir">
      <option value="N">N</option>
      <option value="S">S</option>
    </select>
  </div>

  <div class="coord-label">Longitude:</div>
  <div class="coord-input-group">
    <input id="lonDeg" placeholder="Deg" type="text" style="width:50px;"/>
    <span>¬∞</span>
    <input id="lonMin" placeholder="Min" type="text" style="width:60px;"/>
    <span>'</span>
    <select id="lonDir">
      <option value="E">E</option>
      <option value="W">W</option>
    </select>
  </div>

  <a id="goBtn" class="btn" style="margin-top:6px;">Go/Add</a>

  <h4>Waypoints</h4>
  <div id="list"></div>

  <div>
    <label>Speed (knots for ETA):</label>
    <input id="speedInput" placeholder="kn" type="text"/>
  </div>

  <div style="margin-top:6px;">
    <a id="routeBtn" class="btn">Route selected</a>
    <a id="clearRouteBtn" class="btn" style="background:#999">Clear</a>
  </div>

  <h4>Coords:</h4>
  <div id="coordsOut" class="small">None</div>
  <div id="routeSummary" class="small"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ================= MAP =================
const imageUrl = '70001.JPG';

const bounds = [
  [20.42333, 89.00],   // bottom-left
  [22.66667, 92.00]    // top-right
];

const map = L.map('map', {minZoom:2, maxZoom:18}).fitBounds(bounds);
L.imageOverlay(imageUrl, bounds).addTo(map);

// ================= DATA =================
let waypoints = [];
let markers = {};
let selected = [];
let routeLayer = null;
let checkpointMarkers = [];

const listDiv = document.getElementById('list');
const coordsOut = document.getElementById('coordsOut');
const routeSummaryDiv = document.getElementById('routeSummary');

// ================= COORDINATE CONVERSION =================
function decimalToDMS(decimal, isLat) {
  const absolute = Math.abs(decimal);
  const degrees = Math.floor(absolute);
  const minutesDecimal = (absolute - degrees) * 60;
  const minutes = minutesDecimal.toFixed(3);
  
  let direction;
  if (isLat) {
    direction = decimal >= 0 ? 'N' : 'S';
  } else {
    direction = decimal >= 0 ? 'E' : 'W';
  }
  
  return `${degrees}¬∞ ${minutes}' ${direction}`;
}

function formatCoordinates(lat, lon) {
  return `${decimalToDMS(lat, true)}, ${decimalToDMS(lon, false)}`;
}

function dmsToDecimal(degrees, minutes, direction) {
  let decimal = parseFloat(degrees) + parseFloat(minutes) / 60;
  if (direction === 'S' || direction === 'W') {
    decimal = -decimal;
  }
  return decimal;
}

// ================= FUNCTIONS =================
function renderList(){
  listDiv.innerHTML = '';
  waypoints.forEach(w=>{
    const div = document.createElement('div');
    div.className = 'waypoint-item';
    div.innerHTML = `
      <b>${w.name}</b><br>
      <span class="small">${formatCoordinates(w.lat, w.lon)}</span><br>
      <a class="btn small" onclick="editWaypoint(${w.id})">‚úèÔ∏è</a>
      <a class="btn small" style="background:#dc3545" onclick="deleteWaypoint(${w.id})">üóëÔ∏è</a>
      <a class="btn small" style="background:#6f42c1" onclick="selectWaypoint(${w.id})">üéØ</a>
    `;
    listDiv.appendChild(div);
  });
}

function addWaypoint(lat,lon,name){
  const id = Date.now()+Math.floor(Math.random()*999);
  const wp = {id,lat,lon,name:name||('WP-'+(waypoints.length+1))};
  waypoints.push(wp);

  const marker = L.circleMarker([lat,lon],{
    radius:6,color:'#f00',fillColor:'#f00',fillOpacity:0.9
  })
  .addTo(map)
  .bindPopup(`<b>${wp.name}</b><br>${formatCoordinates(lat, lon)}`);

  marker.on('click',()=>selectWaypoint(wp.id));
  markers[id]=marker;

  renderList();
  saveLocal();
}

function editWaypoint(id){
  const wp = waypoints.find(w=>w.id===id);
  if(!wp)return;
  const newName = prompt('Rename waypoint:', wp.name);
  if(newName!==null && newName.trim()!==''){ wp.name = newName.trim(); }
  renderList();
  saveLocal();
}

function deleteWaypoint(id){
  if(!confirm('Delete this waypoint?'))return;
  waypoints=waypoints.filter(w=>w.id!==id);
  map.removeLayer(markers[id]);
  delete markers[id];
  renderList();
  saveLocal();
}

function selectWaypoint(id){
  const idx = selected.indexOf(id);
  if(idx===-1) selected.push(id);
  else selected.splice(idx,1);

  Object.keys(markers).forEach(k=>{
    const mk=markers[k];
    if(selected.includes(Number(k))) mk.setStyle({color:'#00f',fillColor:'#00f'});
    else mk.setStyle({color:'#f00',fillColor:'#f00'});
  });
}

// ================= NAV CALC =================
function haversineNM(lat1,lon1,lat2,lon2){
  const R=6371e3, toRad=v=>v*Math.PI/180;
  const œÜ1=toRad(lat1),œÜ2=toRad(lat2),ŒîœÜ=toRad(lat2-lat1),ŒîŒª=toRad(lon2-lon1);
  const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))/1852;
}

function makeRoute(){
  if(selected.length<2){alert('Select at least 2'); return;}

  if(routeLayer) map.removeLayer(routeLayer);
  checkpointMarkers.forEach(cp=>map.removeLayer(cp));
  checkpointMarkers=[];

  const latlngs = selected.map(id=>{
    const w=waypoints.find(wp=>wp.id===id);
    return [w.lat,w.lon];
  });

  routeLayer=L.polyline(latlngs,{weight:2}).addTo(map);

  let total=0;
  const speed=parseFloat(document.getElementById('speedInput').value)||0;

  routeSummaryDiv.innerHTML='';
  for(let i=0;i<selected.length-1;i++){
    const a=waypoints.find(w=>w.id===selected[i]);
    const b=waypoints.find(w=>w.id===selected[i+1]);
    const dist=haversineNM(a.lat,a.lon,b.lat,b.lon);
    total+=dist;
    const time=speed>0 ? (dist/speed*60) : 0;
    routeSummaryDiv.innerHTML+=`${a.name} ‚Üí ${b.name}: ${dist.toFixed(2)} NM, ${time.toFixed(1)} min<br>`;
  }
  routeSummaryDiv.innerHTML+=`<b>Total:</b> ${total.toFixed(2)} NM`;
}

function clearRoute(){
  if(routeLayer) map.removeLayer(routeLayer);
  routeLayer=null;
  selected=[];
  routeSummaryDiv.innerHTML='';
  Object.values(markers).forEach(m=>m.setStyle({color:'#f00',fillColor:'#f00'}));
}

// ================= STORAGE =================
function saveLocal(){ localStorage.setItem('map_waypoints_v5',JSON.stringify(waypoints)); }
function loadLocal(){
  const data=localStorage.getItem('map_waypoints_v5');
  if(!data)return;
  try{ JSON.parse(data).forEach(w=>addWaypoint(w.lat,w.lon,w.name)); }
  catch(e){console.error(e);}
}

// ================= EVENTS =================
map.on('click',e=>{
  coordsOut.textContent=formatCoordinates(e.latlng.lat, e.latlng.lng);
  addWaypoint(e.latlng.lat,e.latlng.lng);
});

goBtn.onclick=()=>{
  const latDeg = document.getElementById('latDeg').value;
  const latMin = document.getElementById('latMin').value;
  const latDir = document.getElementById('latDir').value;
  const lonDeg = document.getElementById('lonDeg').value;
  const lonMin = document.getElementById('lonMin').value;
  const lonDir = document.getElementById('lonDir').value;

  if(!latDeg || !latMin || !lonDeg || !lonMin){
    alert('Please enter all coordinate values');
    return;
  }

  const lat = dmsToDecimal(latDeg, latMin, latDir);
  const lon = dmsToDecimal(lonDeg, lonMin, lonDir);

  if(isNaN(lat) || isNaN(lon)){
    alert('Invalid coordinates');
    return;
  }

  map.setView([lat,lon],12);
  addWaypoint(lat,lon,'Manual');
};

routeBtn.onclick=makeRoute;
clearRouteBtn.onclick=clearRoute;

// INIT
loadLocal();
</script>

</body>
</html>